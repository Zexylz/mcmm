Menu="Utilities"
Title="Modpack Manager"
Icon="cubes"
---
<?php
/**
 * Minecraft Modpack Manager for Unraid
 * 
 * Main UI page for the MCMM plugin. This file integrates with the 
 * Unraid webGui system, providing the primary dashboard for 
 * server management and configuration.
 * 
 * It handles the initial page load, pulls server statuses, 
 * and injects the required CSS/JS assets into the document.
 */

// Debug visibility
@ini_set('display_errors', '1');
@error_reporting(E_ALL);

// Load Config
$plugin = 'mcmm';
// @phpstan-ignore-next-line
$config = parse_plugin_cfg($plugin);
$docroot = $_SERVER['DOCUMENT_ROOT'] ?? '/usr/local/emhttp';

// CSRF Protection
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
$csrfToken = $_SESSION['csrf_token'];

// Include helpers if available
if (file_exists("$docroot/plugins/$plugin/include/helpers.php")) {
    require_once "$docroot/plugins/$plugin/include/helpers.php";
} elseif (file_exists(__DIR__ . '/include/helpers.php')) {
    require_once __DIR__ . '/include/helpers.php';
}

if (file_exists("$docroot/plugins/$plugin/include/lib.php")) {
    require_once "$docroot/plugins/$plugin/include/lib.php";
} elseif (file_exists(__DIR__ . '/include/lib.php')) {
    require_once __DIR__ . '/include/lib.php';
}

// Default config values (mirrored in default.cfg, but good to have fallback)
$defaults = [
    'curseforge_api_key' => '',
    'default_server_name' => 'My Modpack Server',
    'default_port' => 25565,
    'default_memory' => '4G',
    'default_max_players' => 20,
    'default_whitelist' => '',
    'default_icon_url' => '',
    'default_pvp' => true,
    'default_hardcore' => false,
    'default_allow_flight' => false,
    'default_command_blocks' => true,
    'default_rolling_logs' => true,
    'default_log_timestamp' => true,
    'default_direct_console' => false,
    'default_aikar_flags' => true,
    'default_meowice_flags' => false,
    'default_graalvm_flags' => false,
    'default_ip' => '0.0.0.0',
    'jvm_flags' => ''
];

$config = array_merge($defaults, $config);

// Helper functions moved to include/helpers.php

$servers = getMinecraftServers();

// Prepare config for JS
$clientConfig = $config;
$clientConfig['has_api_key'] = !empty($clientConfig['curseforge_api_key']);
unset($clientConfig['curseforge_api_key']); // Don't expose key to client logic if not needed, though it is needed for settings form population.
?>
<script>
    (function () {
        function addOnce(el) {
            if (el.id && document.getElementById(el.id)) return;
            document.head.appendChild(el);
        }

        // CSRF Token
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '<?php echo $csrfToken; ?>';
        document.head.appendChild(meta);

        // Google Fonts
        addOnce(Object.assign(document.createElement('link'), {
            id: 'mcmm-fonts-outfit',
            rel: 'stylesheet',
            href: 'https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap'
        }));
        addOnce(Object.assign(document.createElement('link'), {
            id: 'mcmm-fonts-symbols',
            rel: 'stylesheet',
            href: 'https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200'
        }));

        // Plugin CSS
        addOnce(Object.assign(document.createElement('link'), {
            id: 'mcmm-css',
            rel: 'stylesheet',
            href: '<?php echo mcmm_autov("/plugins/mcmm/styles/mcmm.css"); ?>'
        }));

        // Plugin JS
        addOnce(Object.assign(document.createElement('script'), {
            id: 'mcmm-js',
            src: '<?php echo mcmm_autov("/plugins/mcmm/javascript/mcmm.js"); ?>',
            defer: true
        }));
    })();
</script>

<div class="mcmm-app">
    <!-- Debug banner to confirm render -->
    <div id="mcmm-debug-banner"
        style="position:fixed;top:8px;right:8px;z-index:4000;background:#7c3aed;color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;font-family:Arial, sans-serif;box-shadow:0 4px 12px rgb(0 0 0 / 30%);">
        MCMM UI loaded (debug)
    </div>

    <div class="mcmm-scale-wrapper">

        <!-- Header -->
        <header class="mcmm-header">
            <div class="mcmm-brand">
                <span class="material-symbols-outlined">bolt</span> Modpack Manager
            </div>
            <div class="mcmm-version">v1.0.0</div>
        </header>

        <!-- Tabs -->
        <nav class="mcmm-tabs">
            <a href="#" id="tab-main-servers" class="mcmm-tab active"
                onclick="switchTab('servers', this); return false;">My Servers</a>
            <a href="#" id="tab-main-backups" class="mcmm-tab"
                onclick="switchTab('backups', this); return false;">Backups</a>
            <a href="#" id="tab-main-catalog" class="mcmm-tab"
                onclick="switchTab('catalog', this); return false;">Catalog</a>
            <button class="mcmm-btn-icon" onclick="window.openGlobalSettings()" title="Global Settings"
                style="margin-left: auto; margin-bottom: 6px; background: rgb(255 255 255 / 5%) !important; border: 1px solid rgb(255 255 255 / 10%) !important; width: 38px !important; height: 38px !important; position: relative; z-index: 100;">
                <span class="material-symbols-outlined" style="font-size: 1.25rem;">settings</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="mcmm-main">

            <!-- My Servers Tab -->
            <div id="tab-servers" class="mcmm-tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem;">Servers Status</h2>
                    <button class="mcmm-btn mcmm-btn-primary" style="display: flex; align-items: center; gap: 0.5rem;"
                        onclick="switchTab('catalog')">
                        <span class="material-symbols-outlined">cloud_upload</span> Deploy New Server
                    </button>
                </div>

                <?php if (empty($servers)): ?>
                    <div class="mcmm-empty">
                        <h3>No servers found</h3>
                        <p>Get started by deploying your first modpack server.</p>
                        <button class="mcmm-btn mcmm-btn-primary" style="display: flex; align-items: center; gap: 0.5rem;"
                            onclick="switchTab('catalog')"><span class="material-symbols-outlined">search</span> Browse
                            Catalog</button>
                    </div>
                <?php else: ?>
                    <div class="mcmm-server-list" id="serverListContainer">
                        <?php
                        foreach ($servers as $index => $server):
                            $icon = isset($server['icon']) && $server['icon'] ? $server['icon'] : "https://media.forgecdn.net/avatars/8/228/635198031541315682.png";
                            $ramUsage = isset($server['ram']) ? $server['ram'] : 0;
                            $cpuUsage = isset($server['cpu']) ? $server['cpu'] : 0;
                            $mcVersion = $server['mcVersion'] ?? 'Latest';
                            $loader = $server['loader'] ?? 'Vanilla';
                            $statusClass = $server['isRunning'] ? 'running' : 'stopped';
                            $playersOnline = isset($server['players']['online']) ? intval($server['players']['online']) : 0;
                            $playersMax = isset($server['players']['max']) ? intval($server['players']['max']) : (isset($config['default_max_players']) ? intval($config['default_max_players']) : 0);

                            $ramUsedMb = $server['ramUsedMb'] ?? 0;
                            $ramLimitMb = $server['ramLimitMb'] ?? 0;
                            $ramConfigMb = $server['ramConfigMb'] ?? 0;
                            $ramCapMb = $ramConfigMb > 0 ? $ramConfigMb : ($ramLimitMb > 0 ? $ramLimitMb : 0);
                            $ramPercent = $ramCapMb > 0 ? ($ramUsedMb / $ramCapMb * 100) : $ramUsage;
                            $ramPercent = round($ramPercent, 1);
                            $ramUsedLabel = $ramUsedMb > 0 ? number_format($ramUsedMb / 1024, 1) . ' GB' : '0 GB';
                            $ramCapLabel = $ramCapMb > 0 ? number_format($ramCapMb / 1024, 1) . ' GB' : 'N/A';
                            ?>
                            <div class="mcmm-server-row <?php echo $statusClass; ?>">
                                <div class="mcmm-server-icon"
                                    style="background-image: url('<?php echo htmlspecialchars($icon); ?>');"></div>

                                <div class="mcmm-server-info">
                                    <div class="mcmm-server-title">
                                        <?php echo htmlspecialchars($server['name']); ?>
                                        <span class="mcmm-badge"><?php echo htmlspecialchars($mcVersion); ?></span>
                                        <span class="mcmm-badge secondary"><?php echo htmlspecialchars($loader); ?></span>
                                        <?php if (!empty($server['modpackVersion'])): ?>
                                            <span class="mcmm-badge" style="background: rgba(139, 92, 246, 0.15); color: rgb(167 139 250 / 100%); border: 1px solid rgba(139, 92, 246, 0.25);" title="Modpack Version"><?php echo htmlspecialchars((string) $server['modpackVersion']); ?></span>
                                        <?php endif; ?>
                                    </div>
                                    <div class="mcmm-server-subtitle">
                                        <span class="mcmm-status-dot"></span>
                                        <span
                                            class="mcmm-status-text"><?php echo $server['isRunning'] ? 'Online' : 'Offline'; ?></span>
                                        <span style="opacity:0.5;">|</span>
                                        <span>Port: <?php echo htmlspecialchars($server['ports']); ?></span>
                                        <span
                                            style="opacity:0.5; <?php echo $server['isRunning'] ? '' : 'display:none;'; ?>">|</span>
                                        <span class="mcmm-val-players" id="players-<?php echo $server['id']; ?>"
                                            data-server-id="<?php echo $server['id']; ?>"
                                            data-port="<?php echo htmlspecialchars($server['ports']); ?>"
                                            data-running="<?php echo $server['isRunning'] ? '1' : '0'; ?>"
                                            style="<?php echo $server['isRunning'] ? '' : 'display:none;'; ?>">
                                            <?php echo intval($playersOnline); ?> /
                                            <?php echo ($playersMax > 0 ? intval($playersMax) : '?'); ?> players
                                        </span>
                                    </div>
                                </div>

                                <div class="mcmm-server-metrics">
                                    <div class="mcmm-metric">
                                        <div class="mcmm-metric-label">
                                            <span>RAM</span>
                                            <span class="mcmm-val-ram"><?php echo $ramUsedLabel; ?> /
                                                <?php echo $ramCapLabel; ?></span>
                                        </div>
                                        <div class="mcmm-metric-bar">
                                            <div class="mcmm-metric-fill mcmm-bar-ram"
                                                style="<?php echo 'width:' . min(max($ramPercent, 0), 100) . '%'; ?>; background: linear-gradient(90deg, #a855f7, #ec4899);">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mcmm-metric">
                                        <div class="mcmm-metric-label">
                                            <span>CPU</span>
                                            <span class="mcmm-val-cpu"><?php echo number_format($cpuUsage, 2); ?>%</span>
                                        </div>
                                        <div class="mcmm-metric-bar">
                                            <div class="mcmm-metric-fill mcmm-bar-cpu"
                                                style="<?php echo 'width:' . min(max($cpuUsage, 0), 100) . '%'; ?>; background: linear-gradient(90deg, #3b82f6, #06b6d4);">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mcmm-server-actions">
                                    <?php if ($server['isRunning']): ?>
                                        <button class="mcmm-btn-icon danger" title="Stop Server"
                                            onclick="controlServer('<?php echo $server['id']; ?>', 'stop')"><span
                                                class="material-symbols-outlined">stop</span></button>
                                        <button class="mcmm-btn-icon" title="Console"
                                            onclick="openConsole('<?php echo $server['id']; ?>', '<?php echo htmlspecialchars($server['name']); ?>')"><span
                                                class="material-symbols-outlined">terminal</span></button>
                                        <button class="mcmm-btn-icon" title="Players"
                                            onclick="openPlayersModal('<?php echo $server['id']; ?>', '<?php echo htmlspecialchars($server['name']); ?>', '<?php echo htmlspecialchars($server['ports']); ?>')"><span
                                                class="material-symbols-outlined">groups</span></button>
                                    <?php else: ?>
                                        <button class="mcmm-btn-icon success" title="Start Server"
                                            onclick="controlServer('<?php echo $server['id']; ?>', 'start')"><span
                                                class="material-symbols-outlined">play_arrow</span></button>
                                        <button class="mcmm-btn-icon" style="opacity:0.5; cursor:not-allowed;"
                                            title="Console Offline"><span class="material-symbols-outlined">terminal</span></button>
                                        <button class="mcmm-btn-icon" style="opacity:0.5; cursor:not-allowed;"
                                            title="Players Offline"><span class="material-symbols-outlined">groups</span></button>
                                    <?php endif; ?>
                                    <button class="mcmm-btn-icon" title="Mods"
                                        onclick="openModManager('<?php echo $server['id']; ?>', '<?php echo htmlspecialchars($server['name']); ?>')"><span
                                            class="material-symbols-outlined">extension</span></button>
                                    <button class="mcmm-btn-icon" title="Backup"
                                        onclick="createBackup('<?php echo $server['id']; ?>')"><span
                                            class="material-symbols-outlined">cloud_upload</span></button>
                                    <button class="mcmm-btn-icon" title="Settings"
                                        onclick="openServerSettings('<?php echo $server['id']; ?>')"><span
                                            class="material-symbols-outlined">settings</span></button>
                                    <button class="mcmm-btn-icon danger" title="Delete Server"
                                        onclick="deleteServer('<?php echo $server['id']; ?>')"><span
                                            class="material-symbols-outlined">delete</span></button>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="mcmm-btn mcmm-btn-primary" onclick="startAgents()">Restart Metrics Agents</button>
                    </div>
                <?php endif; ?>
            </div>

            <!-- Backups Tab -->
            <div id="tab-backups" class="mcmm-tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.25rem;">Server Backups</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="mcmm-btn" style="display: flex; align-items: center; gap: 0.5rem;"
                            onclick="loadBackups()">
                            <span class="material-symbols-outlined">refresh</span> Refresh List
                        </button>
                        <button class="mcmm-btn mcmm-btn-primary"
                            style="display: flex; align-items: center; gap: 0.5rem;" onclick="switchTab('servers')">
                            <span class="material-symbols-outlined">add</span> Create New Backup
                        </button>
                    </div>
                </div>
                <div id="backups-list-container">
                    <div class="mcmm-empty">
                        <h3>No backups found</h3>
                        <p>Backups you create will appear here. You can reinstall a server to a previous state from
                            these archives.</p>
                    </div>
                </div>
            </div>

            <!-- Catalog Tab -->
            <div id="tab-catalog" class="mcmm-tab-content">
                <div class="mcmm-catalog-header">
                    <div style="display: flex; flex-direction: column; gap: 1rem; width: 100%;">
                        <!-- Source Tabs -->
                        <div class="mcmm-source-tabs">
                            <button class="mcmm-source-tab active"
                                onclick="switchModpackSource('curseforge', this)">CurseForge</button>
                            <button class="mcmm-source-tab"
                                onclick="switchModpackSource('modrinth', this)">Modrinth</button>
                            <button class="mcmm-source-tab" onclick="switchModpackSource('ftb', this)">Feed The
                                Beast</button>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="mcmm-search" style="flex: 1; min-width: 250px;">
                                <span class="material-symbols-outlined mcmm-search-icon">search</span>
                                <input type="text" class="mcmm-search-input" placeholder="Search modpacks..."
                                    id="modpackSearch"
                                    onkeyup="if(event.key === 'Enter') { modpackState.page = 1; loadModpacks(this.value); }" />
                            </div>

                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <label class="mcmm-label"
                                    style="margin: 0; font-size: 0.8rem; white-space: nowrap;">Sort By:</label>
                                <select id="modpackSort" class="mcmm-input"
                                    style="width: auto; min-width: 140px; height: 44px; margin: 0;"
                                    onchange="modpackState.page = 1; loadModpacks(document.getElementById('modpackSearch').value)">
                                    <option value="popularity">Popularity</option>
                                    <option value="newest">Last Updated</option>
                                    <option value="name">Name</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mcmm-modpack-grid" id="modpackGrid">
                    <!-- Loaded via JS -->
                </div>

                <!-- Pagination -->
                <div id="modpackPagination"
                    style="display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 2rem; padding-bottom: 2rem;">
                    <button class="mcmm-btn" id="prevPage" onclick="changeModpackPage(-1)" disabled>
                        <span class="material-symbols-outlined">chevron_left</span> Previous
                    </button>
                    <div style="font-weight: 500; font-size: 0.9rem; color: var(--text-secondary);">
                        Page <span id="currentPageNum" style="color: var(--primary);">1</span>
                    </div>
                    <button class="mcmm-btn" id="nextPage" onclick="changeModpackPage(1)">
                        Next <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Global Settings Modal -->
    <div class="mcmm-modal-overlay" id="globalSettingsModal" style="z-index: 3000;">
        <div class="mcmm-modal"
            style="max-width: 900px !important; width: 95% !important; height: 80vh !important; display: flex; flex-direction: column; overflow: hidden;">
            <div class="mcmm-modal-header" style="flex-shrink: 0;">
                <div class="mcmm-modal-title">Global Settings</div>
                <button class="mcmm-modal-close" onclick="closeGlobalSettings()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <div style="display: flex; flex: 1; overflow: hidden; background: rgb(0 0 0 / 10%);">
                <!-- Sidebar -->
                <div class="mcmm-settings-sidebar"
                    style="width: 220px; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 1rem;">
                    <div class="mcmm-side-link active" onclick="switchSettingsCategory('general', this)">
                        <span class="material-symbols-outlined">settings</span> General
                    </div>
                    <div class="mcmm-side-link" onclick="switchSettingsCategory('integrations', this)">
                        <span class="material-symbols-outlined">link</span> Integrations
                    </div>
                    <div class="mcmm-side-link" onclick="switchSettingsCategory('performance', this)">
                        <span class="material-symbols-outlined">rocket_launch</span> Performance
                    </div>
                    <div class="mcmm-side-link" onclick="switchSettingsCategory('gameplay', this)">
                        <span class="material-symbols-outlined">gamepad</span> Gameplay
                    </div>

                    <div
                        style="margin-top: auto; padding: 1rem; background: rgb(124 58 237 / 5%); border: 1px dashed rgb(124 58 237 / 20%); border-radius: 12px; font-size: 0.75rem; color: var(--text-muted); line-height: 1.4;">
                        <span class="material-symbols-outlined"
                            style="font-size: 1rem; color: var(--primary); margin-bottom: 0.25rem;">info</span>
                        Changes apply as defaults for all new server deployments.
                    </div>
                </div>

                <!-- Content Area -->
                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <form id="settingsForm" onsubmit="saveSettings(event)" style="display: contents;">
                        <div id="settingsCategoryContainer" style="flex: 1; overflow-y: auto; padding: 2rem;">
                            <!-- General -->
                            <div id="settings-general" class="mcmm-settings-pane active">
                                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="material-symbols-outlined"
                                        style="color: var(--primary);">settings</span> General Configuration
                                </h3>
                                <div class="mcmm-form-grid">
                                    <div class="mcmm-form-group">
                                        <label class="mcmm-label">Default Server Name</label>
                                        <input type="text" id="default_server_name" class="mcmm-input"
                                            value="<?php echo htmlspecialchars((string) $config['default_server_name']); ?>" />
                                    </div>
                                    <div class="mcmm-form-group">
                                        <label class="mcmm-label">Default Port</label>
                                        <input type="number" id="default_port" class="mcmm-input"
                                            value="<?php echo htmlspecialchars((string) $config['default_port']); ?>" />
                                    </div>
                                    <div class="mcmm-form-group">
                                        <label class="mcmm-label">Default Max Players</label>
                                        <input type="number" id="default_max_players" class="mcmm-input"
                                            value="<?php echo htmlspecialchars((string) $config['default_max_players']); ?>" />
                                    </div>
                                    <div class="mcmm-form-group">
                                        <label class="mcmm-label">Default Whitelist</label>
                                        <input type="text" id="default_whitelist" class="mcmm-input"
                                            placeholder="User1, User2..."
                                            value="<?php echo htmlspecialchars((string) $config['default_whitelist']); ?>" />
                                    </div>
                                </div>
                                <div class="mcmm-form-group" style="margin-top: 1.5rem;">
                                    <label class="mcmm-label">Default Icon URL</label>
                                    <input type="text" id="default_icon_url" class="mcmm-input"
                                        style="font-family: monospace; font-size: 0.85rem;" placeholder="https://..."
                                        value="<?php echo htmlspecialchars((string) $config['default_icon_url']); ?>" />
                                </div>
                            </div>

                            <!-- Integrations -->
                            <div id="settings-integrations" class="mcmm-settings-pane">
                                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="material-symbols-outlined" style="color: var(--primary);">link</span>
                                    External Integrations
                                </h3>
                                <div class="mcmm-form-group">
                                    <label class="mcmm-label">CurseForge API Key</label>
                                    <div style="position: relative; margin-right: 48px;">
                                        <span class="material-symbols-outlined"
                                            style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); opacity: 0.5; font-size: 1.15rem; pointer-events: none; z-index: 10;">vpn_key</span>
                                        <input type="password" id="curseforge_api_key" class="mcmm-input"
                                            style="padding-left: 54px !important; padding-right: 2px !important;"
                                            placeholder="Paste API Key here..."
                                            value="<?php echo htmlspecialchars((string) $config['curseforge_api_key']); ?>" />
                                        <button type="button" class="mcmm-password-toggle"
                                            style="right: -24px !important;"
                                            onclick="togglePasswordVisibility('curseforge_api_key', this)">
                                            <span class="material-symbols-outlined">visibility</span>
                                        </button>
                                    </div>
                                    <div class="mcmm-input-hint">Required for browsing and installing modpacks from the
                                        catalog.</div>
                                </div>
                            </div>

                            <!-- Performance -->
                            <div id="settings-performance" class="mcmm-settings-pane">
                                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="material-symbols-outlined"
                                        style="color: var(--primary);">rocket_launch</span> Performance Engine
                                </h3>
                                <div class="mcmm-form-group">
                                    <label class="mcmm-label">Default Memory (RAM)</label>
                                    <input type="text" id="default_memory" class="mcmm-input"
                                        value="<?php echo htmlspecialchars((string) $config['default_memory']); ?>" />
                                    <div class="mcmm-ram-presets" style="margin-top: 0.75rem;">
                                        <?php foreach (['4G', '6G', '8G', '10G', '12G'] as $ram): ?>
                                            <div class="mcmm-ram-pill <?php echo $config['default_memory'] == $ram ? 'active' : ''; ?>"
                                                onclick="setRam('<?php echo $ram; ?>')"><?php echo $ram; ?></div>
                                        <?php endforeach; ?>
                                    </div>
                                </div>
                                <div class="mcmm-form-group" style="margin-top: 1.5rem;">
                                    <label class="mcmm-label">Global JVM Flags</label>
                                    <textarea id="jvm_flags" class="mcmm-input"
                                        style="height: 100px; resize: none; font-family: 'Fira Code', monospace; font-size: 0.85rem;"
                                        placeholder="-XX:+UseG1GC ..."><?php echo htmlspecialchars((string) $config['jvm_flags']); ?></textarea>
                                </div>
                                <div style="margin-top: 2rem;">
                                    <label class="mcmm-label">Auto-Optimization Flags</label>
                                    <div class="mcmm-toggle-grid" style="grid-template-columns: 1fr;">
                                        <div class="mcmm-toggle-item">
                                            <div class="mcmm-toggle-label">
                                                <span class="mcmm-toggle-name">Aikar's Flags</span>
                                                <span class="mcmm-toggle-desc">Balanced JVM tuning for Minecraft</span>
                                            </div>
                                            <label class="mcmm-switch">
                                                <input type="checkbox" id="default_aikar_flags" <?php echo boolInput($config['default_aikar_flags']) ? 'checked' : ''; ?> />
                                                <span class="mcmm-slider"></span>
                                            </label>
                                        </div>
                                        <div class="mcmm-toggle-item">
                                            <div class="mcmm-toggle-label">
                                                <span class="mcmm-toggle-name">Meowice Flags</span>
                                                <span class="mcmm-toggle-desc">Aggressive performance tweaks</span>
                                            </div>
                                            <label class="mcmm-switch">
                                                <input type="checkbox" id="default_meowice_flags" <?php echo boolInput($config['default_meowice_flags']) ? 'checked' : ''; ?> />
                                                <span class="mcmm-slider"></span>
                                            </label>
                                        </div>
                                        <div class="mcmm-toggle-item">
                                            <div class="mcmm-toggle-label">
                                                <span class="mcmm-toggle-name">GraalVM Flags</span>
                                                <span class="mcmm-toggle-desc">Optimize for GraalVM/Quarkus</span>
                                            </div>
                                            <label class="mcmm-switch">
                                                <input type="checkbox" id="default_graalvm_flags" <?php echo boolInput($config['default_graalvm_flags']) ? 'checked' : ''; ?> />
                                                <span class="mcmm-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gameplay -->
                            <div id="settings-gameplay" class="mcmm-settings-pane">
                                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                    <span class="material-symbols-outlined"
                                        style="color: var(--primary);">gamepad</span> Default Environment
                                </h3>
                                <div class="mcmm-toggle-grid" style="grid-template-columns: 1fr;">
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Hardcore Mode</span>
                                            <span class="mcmm-toggle-desc">Enable permanent death by default</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_hardcore" <?php echo boolInput($config['default_hardcore']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Enable PVP</span>
                                            <span class="mcmm-toggle-desc">Allow combat between players</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_pvp" <?php echo boolInput($config['default_pvp']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Command Blocks</span>
                                            <span class="mcmm-toggle-desc">Allow command block execution</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_command_blocks" <?php echo boolInput($config['default_command_blocks']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Allow Flight</span>
                                            <span class="mcmm-toggle-desc">Permit flying in survival</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_allow_flight" <?php echo boolInput($config['default_allow_flight']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item"
                                        style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Rolling Logs</span>
                                            <span class="mcmm-toggle-desc">Rotate console logs daily</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_rolling_logs" <?php echo boolInput($config['default_rolling_logs']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Log Timestamp</span>
                                            <span class="mcmm-toggle-desc">Add time to logs</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_log_timestamp" <?php echo boolInput($config['default_log_timestamp']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                    <div class="mcmm-toggle-item">
                                        <div class="mcmm-toggle-label">
                                            <span class="mcmm-toggle-name">Direct Console</span>
                                            <span class="mcmm-toggle-desc">Enable direct TTY attach</span>
                                        </div>
                                        <label class="mcmm-switch">
                                            <input type="checkbox" id="default_direct_console" <?php echo boolInput($config['default_direct_console']) ? 'checked' : ''; ?> />
                                            <span class="mcmm-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mcmm-modal-footer"
                            style="flex-shrink: 0; background: rgb(0 0 0 / 20%); height: 80px; display: flex; align-items: center; justify-content: flex-end; padding: 0 2rem; border-top: 1px solid var(--border);">
                            <div id="settingsStatus" style="margin-right: auto; font-size: 0.85rem; font-weight: 500;">
                            </div>
                            <button type="button" class="mcmm-btn" style="height: 44px; padding: 0 1.5rem;"
                                onclick="closeGlobalSettings()">Cancel</button>
                            <button type="submit" class="mcmm-btn mcmm-btn-primary"
                                style="height: 44px; padding: 0 2rem; font-weight: 700;">Save Configuration</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Deploy Modal -->
    <div class="mcmm-modal-overlay" id="deployModal">
        <div class="mcmm-modal" style="max-width: 680px !important; width: 95% !important;">
            <div class="mcmm-modal-header" style="padding: 0.85rem 1.1rem !important;">
                <div>
                    <div class="mcmm-modal-title" id="deployTitle" style="font-size: 1.05rem !important;">Deploy Server
                    </div>
                    <div style="color: var(--text-secondary); margin-top: 0.1rem; font-size: 0.75rem;"
                        id="deploySubtitle"></div>
                </div>
                <button class="mcmm-modal-close" onclick="closeDeploy()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <div class="mcmm-modal-body" style="display: grid; gap: 0.65rem !important; padding: 1.1rem !important;">
                <div class="mcmm-section-divider">Instance Details</div>
                <div>
                    <label class="mcmm-label" style="font-size: 0.75rem;">Server Name</label>
                    <input type="text" id="deploy_name" class="mcmm-input"
                        value="<?php echo htmlspecialchars((string) $config['default_server_name']); ?>" />
                </div>

                <div class="mcmm-form-group">
                    <label class="mcmm-label">Modpack Version</label>
                    <div id="deployVersionList"
                        style="max-height: 220px; overflow-y: auto; display: grid; gap: 0.5rem; border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem; background: rgb(255 255 255 / 2%);">
                        <!-- version buttons injected -->
                    </div>
                    <div id="deployVersionStatus"
                        style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.4rem;">Loading versions...
                    </div>
                    <input type="hidden" id="deploy_version" value="" />
                    <input type="hidden" id="deploy_java_version" value="" />
                    <input type="hidden" id="deploy_mc_version" value="" />
                    <input type="hidden" id="deploy_loader" value="" />
                    <input type="hidden" id="deploy_modpack_version_name" value="" />
                </div>

                <div class="mcmm-section-divider">Network & Priority</div>
                <div class="mcmm-form-group">
                    <label class="mcmm-label">Deploy Console</label>
                    <div id="deployConsole"
                        style="display:none; background:#0f1014; border:1px solid var(--border); border-radius:10px; padding:0.75rem; max-height:160px; overflow-y:auto; font-family:'Fira Code', monospace; font-size:0.8rem; color:#c0caf5; white-space:pre-wrap; overflow-wrap:anywhere;">
                        <div id="deployConsoleText"></div>
                    </div>
                </div>

                <div class="mcmm-form-grid">
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Server IP</label>
                        <input type="text" id="deploy_ip" class="mcmm-input"
                            value="<?php echo htmlspecialchars((string) ($config['default_ip'] ?? '')); ?>" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Port</label>
                        <input type="number" id="deploy_port" class="mcmm-input"
                            value="<?php echo $config['default_port']; ?>" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Memory</label>
                        <input type="text" id="deploy_memory" class="mcmm-input"
                            value="<?php echo htmlspecialchars((string) $config['default_memory']); ?>" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Max Players</label>
                        <input type="number" id="deploy_max_players" class="mcmm-input"
                            value="<?php echo htmlspecialchars((string) $config['default_max_players']); ?>" />
                    </div>
                </div>

                <div class="mcmm-form-grid">
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Whitelist Users</label>
                        <input type="text" id="deploy_whitelist" class="mcmm-input"
                            value="<?php echo htmlspecialchars((string) $config['default_whitelist']); ?>"
                            placeholder="user1, user2" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Server Icon URL</label>
                        <input type="text" id="deploy_icon_url" class="mcmm-input"
                            value="<?php echo htmlspecialchars((string) $config['default_icon_url']); ?>"
                            placeholder="https://..." />
                    </div>
                </div>

                <div class="mcmm-section-divider">Environment & Rules</div>
                <div class="mcmm-toggle-grid">
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">PVP</span>
                            <span class="mcmm-toggle-desc">Enable player combat</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_pvp" <?php echo $config['default_pvp'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Hardcore</span>
                            <span class="mcmm-toggle-desc">Permanent death</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_hardcore" <?php echo $config['default_hardcore'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Allow Flight</span>
                            <span class="mcmm-toggle-desc">Permit flying in survival</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_allow_flight" <?php echo $config['default_allow_flight'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Command Blocks</span>
                            <span class="mcmm-toggle-desc">Enable command blocks</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_command_blocks" <?php echo $config['default_command_blocks'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Rolling Logs</span>
                            <span class="mcmm-toggle-desc">Rotate logs automatically</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_rolling_logs" <?php echo $config['default_rolling_logs'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Log Timestamp</span>
                            <span class="mcmm-toggle-desc">Add time to logs</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_log_timestamp" <?php echo $config['default_log_timestamp'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Aikar Flags</span>
                            <span class="mcmm-toggle-desc">Use Aikar JVM tuning</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_aikar_flags" <?php echo $config['default_aikar_flags'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Meowice Flags</span>
                            <span class="mcmm-toggle-desc">Extra JVM tweaks</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_meowice_flags" <?php echo $config['default_meowice_flags'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">GraalVM</span>
                            <span class="mcmm-toggle-desc">Use GraalVM JDK</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="deploy_graalvm_flags" <?php echo $config['default_graalvm_flags'] ? 'checked' : ''; ?> />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="mcmm-section-divider">Technical Configuration</div>
                <div class="mcmm-form-group">
                    <label class="mcmm-label">JVM Flags</label>
                    <textarea id="deploy_jvm_flags" class="mcmm-input"
                        style="height: 70px; resize: vertical; font-family: 'Fira Code', monospace; font-size: 0.85rem;"><?php echo htmlspecialchars((string) $config['jvm_flags']); ?></textarea>
                </div>

                <div id="deployStatus" class="mcmm-status" style="display: none;"></div>
            </div>

            <div class="mcmm-settings-footer" style="padding: 0 1.25rem 1.25rem;">
                <button type="button" class="mcmm-btn" style="margin-right: auto;"
                    onclick="closeDeploy()">Cancel</button>
                <button type="button" class="mcmm-btn mcmm-btn-primary" onclick="submitDeploy()">Deploy</button>
            </div>
        </div>
    </div>

    <!-- Deploy Progress Modal -->
    <div class="mcmm-modal-overlay" id="deployProgressModal">
        <div class="mcmm-modal" style="max-width: 800px !important; width: 95% !important; height: 75vh !important;">
            <div class="mcmm-modal-header">
                <div>
                    <div class="mcmm-modal-title">Deployment Progress</div>
                    <div style="color: var(--text-secondary); margin-top: 0.25rem;" id="deployProgressSubtitle">
                        Starting...</div>
                </div>
                <button class="mcmm-modal-close" onclick="closeDeployProgress()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <div class="mcmm-modal-body"
                style="display: grid; gap: 1rem; padding: 1rem; grid-template-rows: auto auto 1fr;">
                <div id="deploySteps" style="display: grid; gap: 0.5rem;">
                    <div class="deploy-step" data-step="submit"
                        style="padding: 0.75rem 1rem; border:1px solid var(--border); border-radius:10px; display:flex; align-items:center; gap:0.75rem;">
                        <span class="step-dot"
                            style="width:12px;height:12px;border-radius:50%;background:var(--warning);"></span>
                        <div>
                            <div style="font-weight:700;">Submitting deployment</div>
                            <div class="step-desc" style="color:var(--text-secondary); font-size:0.85rem;">Waiting for
                                API response</div>
                        </div>
                        <div class="step-status"
                            style="margin-left:auto; color:var(--text-secondary); font-weight:600;">Pending</div>
                    </div>
                    <div class="deploy-step" data-step="create"
                        style="padding: 0.75rem 1rem; border:1px solid var(--border); border-radius:10px; display:flex; align-items:center; gap:0.75rem;">
                        <span class="step-dot"
                            style="width:12px;height:12px;border-radius:50%;background:var(--border);"></span>
                        <div>
                            <div style="font-weight:700;">Creating container</div>
                            <div class="step-desc" style="color:var(--text-secondary); font-size:0.85rem;">docker run
                            </div>
                        </div>
                        <div class="step-status"
                            style="margin-left:auto; color:var(--text-secondary); font-weight:600;">Pending</div>
                    </div>
                    <div class="deploy-step" data-step="start"
                        style="padding: 0.75rem 1rem; border:1px solid var(--border); border-radius:10px; display:flex; align-items:center; gap:0.75rem;">
                        <span class="step-dot"
                            style="width:12px;height:12px;border-radius:50%;background:var(--border);"></span>
                        <div>
                            <div style="font-weight:700;">Starting server</div>
                            <div class="step-desc" style="color:var(--text-secondary); font-size:0.85rem;">Watching
                                container logs</div>
                        </div>
                        <div class="step-status"
                            style="margin-left:auto; color:var(--text-secondary); font-weight:600;">Pending</div>
                    </div>
                </div>

                <div>
                    <div style="font-weight:700; margin-bottom:0.5rem;">Live Console</div>
                    <div id="deployProgressConsole"
                        style="background:#0f1014; border:1px solid var(--border); border-radius:10px; padding:0.75rem; height:60vh; max-height:60vh; overflow-y:auto; font-family:'Fira Code', monospace; font-size:0.9rem; color:#c0caf5; white-space:pre-wrap; overflow-wrap:anywhere;">
                        <div id="deployProgressConsoleText">Waiting for logs...</div>
                    </div>
                </div>
            </div>

            <div class="mcmm-settings-footer" style="padding: 0 1.25rem 1.25rem; gap: 0.5rem;">
                <button type="button" class="mcmm-btn" onclick="closeDeployProgress()">Close</button>
                <button type="button" class="mcmm-btn mcmm-btn-primary" id="deployProgressViewBtn" style="display:none;"
                    onclick="finishDeployAndView()">View Server</button>
            </div>
        </div>
    </div>

    <!-- Mod Manager Modal -->
    <div class="mcmm-modal-overlay" id="modManagerModal">
        <div class="mcmm-modal"
            style="max-width: 95vw; width: 1600px; height: 90vh; display: flex; flex-direction: column;">
            <!-- Header -->
            <div class="mcmm-modal-header" style="border-bottom: none; padding-bottom: 0;">
                <div>
                    <div class="mcmm-modal-title">Mod Manager</div>
                    <div style="color: var(--text-secondary); margin-top: 0.25rem;" id="modManagerSubtitle"></div>
                </div>
                <button class="mcmm-modal-close" onclick="closeModManager()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <!-- Search Row -->
            <div style="padding: 1rem 1.5rem 0.5rem; display: flex; gap: 1rem; align-items: center;">
                <div class="mcmm-search" style="flex: 1; max-width: none;">
                    <span class="mcmm-search-icon"></span>
                    <input type="text" class="mcmm-search-input" placeholder="Search for mods..." id="modSearchInput"
                        onkeyup="filterMods()" />
                </div>

                <!-- Sort Selector (custom dropdown) -->
                <div id="modSortSelector" style="min-width: 220px;">
                    <div class="mcmm-select" id="modSortSelect" data-target="mod_sort_value">
                        <div class="mcmm-select-trigger" onclick="toggleSelect('modSortSelect')">Sort: Popular</div>
                        <div class="mcmm-select-options">
                            <div class="mcmm-option selected"
                                onclick="selectOption('modSortSelect', 'popular', 'Sort: Popular'); setModSort('popular');">
                                Popular</div>
                            <div class="mcmm-option"
                                onclick="selectOption('modSortSelect', 'downloads', 'Sort: Downloads'); setModSort('downloads');">
                                Downloads</div>
                            <div class="mcmm-option"
                                onclick="selectOption('modSortSelect', 'name', 'Sort: Name (AZ)'); setModSort('name');">
                                Name (AZ)</div>
                            <div class="mcmm-option"
                                onclick="selectOption('modSortSelect', 'name_desc', 'Sort: Name (ZA)'); setModSort('name_desc');">
                                Name (ZA)</div>
                            <div class="mcmm-option"
                                onclick="selectOption('modSortSelect', 'author', 'Sort: Author (AZ)'); setModSort('author');">
                                Author (AZ)</div>
                        </div>
                        <input type="hidden" id="mod_sort_value" value="popular" />
                    </div>
                </div>
            </div>

            <!-- Toolbar Row -->
            <div
                style="padding: 0 1.5rem 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border);">
                <!-- Tabs -->
                <div class="mcmm-tabs" style="margin: 0; border: none; padding: 0; width: auto;">
                    <button class="mcmm-tab active" onclick="switchModTab('all', this)">Install Mods</button>
                    <button class="mcmm-tab" onclick="switchModTab('installed', this)">Installed Mods</button>
                    <button class="mcmm-tab" onclick="switchModTab('updates', this)">Updates</button>
                </div>

                <!-- Active Filter Display -->
                <div id="activeFilterContainer"
                    style="display: none; align-items: center; gap: 0.5rem; background: rgb(157 78 221 / 10%); padding: 0.4rem 0.8rem; border-radius: 6px; border: 1px solid var(--primary-dim); cursor: pointer;"
                    onclick="changeModFilterVersion()" title="Click to manually change version filter">
                    <span style="font-size: 0.85rem; color: var(--primary-hover); font-weight: 600;"
                        id="activeFilterText">Filtering: Detect...</span>
                    <!-- Close button stays for clearing filter -->
                    <button onclick="event.stopPropagation(); clearModFilters()"
                        style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 0; line-height: 1; margin-left: 0.3rem;"
                        title="Clear Filter"></button>
                </div>

                <!-- Source Toggle -->
                <div class="mcmm-source-toggle">
                    <button class="mcmm-source-btn active"
                        onclick="switchSource('curseforge', this)">CurseForge</button>
                    <button class="mcmm-source-btn" onclick="switchSource('modrinth', this)">Modrinth</button>
                </div>
            </div>

            <!-- List -->
            <div class="mcmm-modal-body"
                style="padding: 0; flex: 1; overflow: hidden; display: flex; position: relative;">
                <div id="modList"
                    style="padding: 1.5rem; height: 100%; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.25rem; align-content: start; flex: 1; min-width: 0;">
                    <!-- Mods injected here -->
                </div>

                <!-- Pagination (bottom-center) -->
                <div id="modsPaginationBar" class="mcmm-pagination-bar"></div>

                <!-- Queue Panel (Popout) -->
                <div id="modQueuePanel" class="mcmm-queue-panel">
                    <div class="mcmm-queue-header">
                        <div style="font-weight: 700; font-size: 1.1rem;">Installation Queue</div>
                        <button class="mcmm-btn-icon danger" onclick="clearQueue()"
                            style="width: 32px; height: 32px; font-size: 0.9rem;" title="Clear Queue"></button>
                    </div>
                    <div
                        style="padding: 0 1.25rem 0.5rem; color: var(--text-secondary); font-size: 0.85rem; border-bottom: 1px solid var(--border);">
                        <span id="queueCount">0 items</span>
                    </div>
                    <div id="queueList" class="mcmm-queue-list">
                        <!-- Queue items -->
                    </div>
                    <div class="mcmm-queue-footer">
                        <button id="btnInstallSelected" class="mcmm-btn mcmm-btn-primary"
                            onclick="installSelectedMods()" style="width: 100%; justify-content: center;">
                            Install Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Settings Modal -->
    <div class="mcmm-modal-overlay" id="serverSettingsModal">
        <div class="mcmm-modal" style="max-width: 680px !important; width: 95% !important;">
            <div class="mcmm-modal-header" style="padding: 0.85rem 1.1rem !important;">
                <div>
                    <div class="mcmm-modal-title" id="serverSettingsTitle" style="font-size: 1.05rem !important;">Server
                        Settings</div>
                    <div style="color: var(--text-secondary); margin-top: 0.1rem; font-size: 0.75rem;">Edit
                        configuration</div>
                </div>
                <button class="mcmm-modal-close" onclick="closeServerSettings()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <div class="mcmm-modal-body" style="display: grid; gap: 0.65rem !important; padding: 1.1rem !important;">
                <input type="hidden" id="edit_server_id" />

                <div class="mcmm-section-divider">Network Configuration</div>
                <div class="mcmm-form-grid">
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Server IP</label>
                        <input type="text" id="edit_ip" class="mcmm-input" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Port</label>
                        <input type="number" id="edit_port" class="mcmm-input" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Memory</label>
                        <input type="text" id="edit_memory" class="mcmm-input" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Max Players</label>
                        <input type="number" id="edit_max_players" class="mcmm-input" />
                    </div>
                </div>

                <div class="mcmm-form-grid">
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Whitelist Users</label>
                        <input type="text" id="edit_whitelist" class="mcmm-input" placeholder="user1, user2" />
                    </div>
                    <div class="mcmm-form-group">
                        <label class="mcmm-label">Server Icon URL</label>
                        <input type="text" id="edit_icon_url" class="mcmm-input" placeholder="https://..." />
                        <div id="edit_icon_preview"
                            style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <div
                                style="width:48px; height:48px; border:1px solid var(--border); border-radius:10px; background: rgb(255 255 255 / 4%); display:flex; align-items:center; justify-content:center; color: var(--text-muted); font-size:0.8rem;">
                                No Image</div>
                            <div style="color: var(--text-secondary); font-size: 0.85rem;">Preview</div>
                        </div>
                    </div>
                </div>

                <div class="mcmm-section-divider">Server Parameters</div>
                <div class="mcmm-toggle-grid">
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">PVP</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_pvp" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Hardcore</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_hardcore" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Allow Flight</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_allow_flight" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Command Blocks</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_command_blocks" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Rolling Logs</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_rolling_logs" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Log Timestamp</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_log_timestamp" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Aikar Flags</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_aikar_flags" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">Meowice Flags</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_meowice_flags" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                    <div class="mcmm-toggle-item">
                        <div class="mcmm-toggle-label">
                            <span class="mcmm-toggle-name">GraalVM</span>
                        </div>
                        <label class="mcmm-switch">
                            <input type="checkbox" id="edit_graalvm_flags" />
                            <span class="mcmm-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="mcmm-form-group">
                    <label class="mcmm-label">JVM Flags</label>
                    <textarea id="edit_jvm_flags" class="mcmm-input"
                        style="height: 70px; resize: vertical; font-family: 'Fira Code', monospace; font-size: 0.85rem;"></textarea>
                </div>

                <div id="editStatus" class="mcmm-status" style="display: none;"></div>

                <div
                    style="font-size: 0.8rem; color: var(--warning); padding: 0.5rem; border: 1px solid rgb(251 191 36 / 20%); border-radius: 6px; background: rgb(251 191 36 / 5%);">
                    Note: Saving changes will restart the server.
                </div>
            </div>

            <div class="mcmm-settings-footer" style="padding: 0 1.25rem 1.25rem;">
                <button type="button" class="mcmm-btn" style="margin-right: auto;"
                    onclick="closeServerSettings()">Cancel</button>
                <button type="button" class="mcmm-btn mcmm-btn-primary" onclick="submitServerSettings()">Save &
                    Restart</button>
            </div>
        </div>
    </div>

    <!-- Console Modal -->
    <div class="mcmm-modal-overlay" id="consoleModal">
        <div class="mcmm-modal" style="height: 65vh !important; max-width: 800px !important; width: 95% !important;">
            <div class="mcmm-modal-header">
                <div class="mcmm-modal-title" id="consoleTitle">Server Console</div>
                <button class="mcmm-modal-close" onclick="closeConsole()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <div class="mcmm-console-window"
                style="margin: 0 !important; border: none !important; border-radius: 0 !important;">
                <div class="mcmm-console-output-container" style="padding: 1.25rem !important;">
                    <div class="mcmm-console-output" id="consoleOutput"></div>
                </div>

                <div class="mcmm-console-input-row">
                    <span class="mcmm-console-prompt">></span>
                    <input type="text" class="mcmm-console-input" id="consoleInput" placeholder="Send command..." />
                </div>
            </div>
        </div>
    </div>

    <!-- Players Modal -->
    <div class="mcmm-modal-overlay" id="playersModal">
        <div class="mcmm-modal"
            style="max-width: 480px !important; width: 95% !important; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border) !important; box-shadow: 0 15px 40px rgb(0 0 0 / 40%) !important; background: var(--bg-surface) !important;">
            <div class="mcmm-modal-header"
                style="border-bottom: 1px solid var(--border); padding: 1rem 1.25rem; background: var(--bg-surface) !important;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="mcmm-modal-title"
                        style="font-size: 1.1rem; font-weight: 700; color: var(--text-main) !important;">Player Manager
                    </div>
                    <span id="playerTotalBadge"
                        style="background: var(--bg-surface-hover); border: 1px solid var(--border); color: var(--text-muted); font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; font-weight: 600; opacity: 0; transition: opacity 0.3s;">0/0</span>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="mcmm-btn-refresh-mini" onclick="refreshPlayers()" title="Refresh"
                        style="background: transparent; border: none; color: var(--text-muted); cursor: pointer; transition: color 0.15s; padding: 4px; display: flex; align-items: center;">
                        <span class="material-symbols-outlined" style="font-size: 1.25rem;">refresh</span>
                    </button>
                    <button class="mcmm-modal-close" onclick="closePlayersModal()"
                        style="opacity: 0.5; color: var(--text-main) !important; background: transparent; border: none; cursor: pointer; padding: 4px; display: flex; align-items: center;"><span
                            class="material-symbols-outlined">close</span></button>
                </div>
            </div>

            <div style="display: flex; background: var(--bg-surface); border-bottom: 1px solid var(--border);">
                <button id="tab-active" class="mcmm-modal-tab active" onclick="switchPlayerTab('active')"
                    style="flex: 1; padding: 0.75rem; background: transparent; border: none; border-bottom: 2px solid var(--accent-primary); color: var(--text-main); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Active</button>
                <button id="tab-banned" class="mcmm-modal-tab" onclick="switchPlayerTab('banned')"
                    style="flex: 1; padding: 0.75rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Banned</button>
            </div>

            <input type="text" id="playerSearch" class="mcmm-player-search-box" placeholder="Search players..."
                onkeyup="filterPlayers()">

            <div id="playersBody" class="mcmm-modal-body" style="padding: 0; max-height: 60vh; overflow-y: auto;">
                <div style="text-align:center; padding: 4rem 2rem; color: var(--text-secondary);">
                    <div class="mcmm-spinner" style="width: 24px; height: 24px; border-width: 3px;"></div>
                    <div
                        style="margin-top: 1rem; font-weight: 500; font-size: 0.85rem; letter-spacing: 0.5px; opacity: 0.8;">
                        SCANNING PLAYERS...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version Selection Modal -->
    <div class="mcmm-modal-overlay" id="versionSelectModal" style="z-index: 2000;">
        <div class="mcmm-modal" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="mcmm-modal-header">
                <div>
                    <div class="mcmm-modal-title">Select Version</div>
                    <div style="color: var(--text-secondary); margin-top: 0.25rem;" id="versionSelectSubtitle"></div>
                </div>
                <button class="mcmm-modal-close" onclick="closeVersionSelect()"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div id="versionListContainer" class="mcmm-modal-body" style="overflow-y: auto; padding: 0;">
                <!-- Versions loaded here -->
            </div>
            <div class="mcmm-settings-footer" style="padding: 1.25rem;">
                <button type="button" class="mcmm-btn" style="margin-right: auto;"
                    onclick="closeVersionSelect()">Cancel</button>
                <button type="button" class="mcmm-btn mcmm-btn-primary" id="btnConfirmVersion"
                    onclick="confirmVersionInstall()" disabled>Install Selected</button>
            </div>
        </div>
    </div>
</div>

<script>
    const mcmmConfig = <?php echo json_encode($clientConfig); ?>;
    // @phpstan-ignore-next-line
    const csrfToken = "<?php echo $var['csrf_token'] ?? ''; ?>";
</script>
<script src="/plugins/mcmm/javascript/mcmm.js?v=<?php echo time(); ?>"></script>