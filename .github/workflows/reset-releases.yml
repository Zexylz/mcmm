name: Reset Releases and Tags

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm DELETION of ALL releases and tags.'
        required: true

jobs:
  reset-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Verify Confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "yes" ]; then
            echo "Confirmation failed. You must type 'yes' to proceed."
            exit 1
          fi

      - name: Delete all Releases and Tags
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "Fetching all releases..."
          # List all releases and delete them (including tags)
          gh release list --limit 1000 --json tagName --jq '.[].tagName' | while read -r tag; do
            echo "Deleting release and tag: $tag"
            gh release delete "$tag" --yes --cleanup-tag || echo "Failed to delete release $tag, continuing..."
          done
          
          # Delete any remaining tags (local and remote) not associated with a release
          git fetch --tags
          git tag -l | while read -r tag; do
             echo "Deleting remaining tag: $tag"
             git push origin --delete "$tag" || echo "Failed to delete remote tag $tag"
             git tag -d "$tag" || echo "Failed to delete local tag $tag"
          done

      - name: Reset package.json to 0.0.0
        run: |
          npm version 0.0.0 --no-git-tag-version --allow-same-version

      - name: Commit and Push Reset
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add package.json
          git add package-lock.json || true
          
          git commit -m "chore: reset version to 0.0.0 [skip ci]" || echo "Already at 0.0.0"
          git push origin HEAD:main

      - name: Create v0.0.0 Tag
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          git tag v0.0.0
          git push origin v0.0.0
          # Manually trigger release for v0.0.0 if needed, or let the push trigger handle it (if PAT is working)
