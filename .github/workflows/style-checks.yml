name: Style Checks

on:
  workflow_dispatch:
    inputs:
      phpcs:
        description: "Run PHPCS"
        type: boolean
        default: true
      phpstan:
        description: "Run PHPStan"
        type: boolean
        default: true
      eslint:
        description: "Run ESLint"
        type: boolean
        default: true
      stylelint:
        description: "Run Stylelint"
        type: boolean
        default: true
      htmlhint:
        description: "Run HTMLHint"
        type: boolean
        default: true

  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# --------------------------------------------------------------------
# PHP JOBS (parallel zu Node-Jobs)
# --------------------------------------------------------------------

jobs:
  phpcs:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.phpcs }}
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          tools: phpcs
      - run: phpcs --standard=.github/linters/phpcs.xml --extensions=php,page .

  phpstan:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.phpstan }}
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          tools: phpstan
      - run: phpstan analyse --configuration=.github/linters/phpstan.neon --memory-limit=1G

# --------------------------------------------------------------------
# ESLINT (parallel)
# --------------------------------------------------------------------

  eslint:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.eslint }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - run: npm ci --no-audit --no-fund

      - name: Determine changed files
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1
          git diff --name-only "origin/${{ github.base_ref }}"...HEAD > .changed.txt

      - run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            mapfile -t files < <(grep -E '\.js$' .changed.txt || true)
            [[ ${#files[@]} -eq 0 ]] && echo "No JS changes" && exit 0
            npx eslint "${files[@]}" --max-warnings 0 --format stylish
          else
            npx eslint "**/*.js" --max-warnings 0 --format stylish
          fi

# --------------------------------------------------------------------
# STYLELINT (parallel)
# --------------------------------------------------------------------

  stylelint:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.stylelint }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - run: npm ci --no-audit --no-fund

      - name: Determine changed files
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git fetch origin "${{ github.base_ref }}" --depth=1
          git diff --name-only "origin/${{ github.base_ref }}"...HEAD > .changed.txt

      - name: Extract CSS from .page
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          mkdir -p .tmp-stylelint

          extract_page() {
            f="$1"

            # <style> blocks
            awk '
              BEGIN{in=0}
              /<style/{in=1;next}
              /<\/style>/{in=0;next}
              in{print}
            ' "$f" > ".tmp-stylelint/${f%.page}.style.css"

            # inline styles (PHP-safe, dummy selector)
            perl -0777 -ne '
              s/<\?(?:php|=).*?\?>//gis;
              s{<script.*?</script>}{}gis;
              s{<style.*?</style>}{}gis;

              my $i=0;
              while (/style\s*=\s*"([^"]+)"/gis) {
                my $s=$1;
                next if $s =~ /<\?/;
                $s =~ s/&quot;/"/g;
                $s =~ s/&amp;/&/g;
                $s =~ s/\s*;\s*$/;/;
                $s.=";" unless $s =~ /;$/;
                $i++;
                print ".__inline_$i { $s }\n";
              }
            ' "$f" > ".tmp-stylelint/${f%.page}.inline.css"
          }

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            grep -E '\.page$' .changed.txt | while read -r f; do
              [[ -f "$f" ]] && extract_page "$f"
            done
          else
            for f in **/*.page; do extract_page "$f"; done
          fi

          find .tmp-stylelint -type f -size 0 -delete

      - run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            mapfile -t css < <(grep -E '\.css$' .changed.txt || true)
            npx stylelint "${css[@]}" ".tmp-stylelint/**/*.css" \
              --config .github/linters/.stylelintrc.json \
              --formatter verbose \
              --max-warnings 0
          else
            npx stylelint "**/*.css" ".tmp-stylelint/**/*.css" \
              --config .github/linters/.stylelintrc.json \
              --formatter verbose \
              --max-warnings 0
          fi

# --------------------------------------------------------------------
# HTMLHINT (parallel)
# --------------------------------------------------------------------

  htmlhint:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.htmlhint }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
      - run: npm ci --no-audit --no-fund

      - name: Prepare HTML
        run: |
          set -euo pipefail
          shopt -s globstar nullglob
          mkdir -p .tmp-htmlhint

          for f in **/*.page; do
            awk '
              BEGIN{h=0}
              /<!doctype html|<html/{h=1}
              h{print}
            ' "$f" > ".tmp-htmlhint/${f%.page}.html"
          done

      - run: npx htmlhint .tmp-htmlhint/**/*.html
