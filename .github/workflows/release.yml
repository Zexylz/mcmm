name: Create Release

on:
  push:
    tags:
      - "v*"
  release:
    types:
      - prereleased
      - released
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Type of version bump (ignored if triggered by tag push)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # MANUALLY TRIGGERED: Bumps version, commits, and pushes a new tag
  # This tag push will then trigger the THIS SAME WORKFLOW via the push: tags trigger
  bump-version:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate and Push Version
        id: version
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi
          
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r major minor patch <<< "$VERSION"
          
          BUMP_TYPE="${{ inputs.bump_type }}"
          if [ "$BUMP_TYPE" == "major" ]; then
            major=$((major + 1)); minor=0; patch=0
          elif [ "$BUMP_TYPE" == "minor" ]; then
            minor=$((minor + 1)); patch=0
          else
            patch=$((patch + 1))
          fi
          
          NEW_VERSION="$major.$minor.$patch"
          NEW_TAG="v$NEW_VERSION"
          
          echo "New Version: $NEW_VERSION"
          
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version
          git add package.json package-lock.json || true
          
          if ! git diff --cached --quiet; then
            git commit -m "chore: bump version to $NEW_VERSION"
            git push origin HEAD:main
          fi
          
          git tag $NEW_TAG
          git push origin $NEW_TAG

  # TRIGGERED BY: v* tag push (either manual or from bump-version job)
  create-release:
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.14'

      - name: Install Dependencies
        run: pip install google-genai

      - name: Generate AI Release Notes
        id: ai_notes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          python .github/scripts/generate_release_notes.py
          echo "NOTES_FILE=release_notes.md" >> "$GITHUB_ENV"

      - name: Create Release Package
        shell: bash
        run: |
          set -euo pipefail
          required_files=("api.php" "default.cfg" ".htaccess" "mcmm.page")
          required_dirs=("include" "images" "javascript" "styles")
          
          for f in "${required_files[@]}"; do
            [[ -f "$f" ]] || { echo "ERROR: '$f' not found!"; exit 1; }
          done
          for d in "${required_dirs[@]}"; do
            [[ -d "$d" ]] || { echo "ERROR: '$d' not found!"; exit 1; }
          done
          
          mkdir -p release/mcmm
          cp -r include images javascript styles release/mcmm/
          cp api.php default.cfg .htaccess mcmm.page release/mcmm/
          cd release && zip -r ../mcmm-plugin.zip mcmm
          
      - name: Validate ZIP package
        shell: bash
        run: |
          set -euo pipefail
          [[ -f "mcmm-plugin.zip" ]] || { echo "ERROR: ZIP not created!"; exit 1; }
          unzip -t mcmm-plugin.zip > /dev/null
          echo "ZIP validation successful"
          
          # Show package contents
          echo "Package contents:"
          unzip -l mcmm-plugin.zip | tail -n +4 | head -n -2

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: mcmm-plugin.zip
          tag_name: ${{ github.ref_name }}
          prerelease: false
          draft: false
          generate_release_notes: false
          body_path: release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

      - name: Update README with Dynamic Content
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Ensure we are on the absolute latest main
          git fetch origin main
          git reset --hard origin/main
          python .github/scripts/update_readme.py
          git add README.md
          git commit -m "chore: update README with release notes for ${{ github.ref_name }}" || echo "No changes to README"
          git push origin HEAD:main

  # TRIGGERED BY: release created/published
  unraid-plugin:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Build and Package Plugin
        id: build
        run: |
          chmod +x build.sh
          ./build.sh
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          PACKAGE_NAME="mcmm-plugin"
          PACKAGE_FILE="${PACKAGE_NAME}-${VERSION}-noarch-1.txz"
          
          mkdir -p release
          cd src && tar --owner=0 --group=0 -cJf "../release/${PACKAGE_FILE}" * && cd ..
          CHECKSUM=$(sha256sum "release/${PACKAGE_FILE}" | awk '{print $1}')
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"
          echo "package_file=release/$PACKAGE_FILE" >> "$GITHUB_OUTPUT"

      - name: Generate PLG file
        uses: dkaser/jinja2-action@v1.4.0
        with:
          template: plugin/plugin.j2
          output_file: plugin/mcmm.plg
          data_file: plugin/plugin.json
        env:
          PLUGIN_VERSION: ${{ steps.build.outputs.version }}
          PLUGIN_CHANGELOG: "Release notes: ${{ github.event.release.html_url }}"
          PLUGIN_CHECKSUM: ${{ steps.build.outputs.checksum }}
          PLUGIN_RELEASE: ""
          PLUGIN_TAG: ${{ github.event.release.tag_name }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
          
      - name: Commit PLG file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --hard origin/main
          # Re-generate PLG based on latest main to be safe
          # (The files from previous steps are still in the workspace)
          git checkout HEAD -- plugin/mcmm.plg || true
          git add plugin/mcmm.plg
          if ! git diff --cached --quiet; then
            git commit -m "chore: update plugin file for release ${{ github.event.release.tag_name }}" || echo "No changes"
            git push origin HEAD:main
          fi
          
      - name: Upload Package Asset
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: ${{ steps.build.outputs.package_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
