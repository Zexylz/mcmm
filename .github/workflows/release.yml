name: Create Release

on:
  push:
    tags:
      - "v*"
  release:
    types:
      - prereleased
      - released
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Create Release Package
        shell: bash
        run: |
          set -euo pipefail
          
          # Validate required files exist
          required_files=("api.php" "default.cfg" ".htaccess" "mcmm.page")
          required_dirs=("include" "images" "javascript" "styles")
          
          for f in "${required_files[@]}"; do
            if [[ ! -f "$f" ]]; then
              echo "ERROR: Required file '$f' not found!"
              exit 1
            fi
          done
          
          for d in "${required_dirs[@]}"; do
            if [[ ! -d "$d" ]]; then
              echo "ERROR: Required directory '$d' not found!"
              exit 1
            fi
          done
          
          mkdir -p release/mcmm
          cp -r include release/mcmm/
          cp -r images release/mcmm/
          cp -r javascript release/mcmm/
          cp -r styles release/mcmm/
          cp api.php release/mcmm/
          cp default.cfg release/mcmm/
          cp .htaccess release/mcmm/
          cp mcmm.page release/mcmm/
          cd release
          zip -r ../mcmm-plugin.zip mcmm
          
      - name: Validate ZIP package
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f "mcmm-plugin.zip" ]]; then
            echo "ERROR: ZIP file was not created!"
            exit 1
          fi
          
          # Validate ZIP integrity
          unzip -t mcmm-plugin.zip > /dev/null
          echo "ZIP validation successful"
          
          # Show package contents
          echo "Package contents:"
          unzip -l mcmm-plugin.zip | tail -n +4 | head -n -2

      - name: Generate AI Release Notes
        id: ai_notes
        uses: reservamos/ai-release-notes-action@v1.0.0
        with:
          apiKey: ${{ secrets.OPENAI_API_KEY }}
          model: "gpt-5.2"
          version: v1.0.0
          language: "en"
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

      # Normale Release bei v* Tag-Push
      - name: Create GitHub Release (tag)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: mcmm-plugin.zip
          tag_name: ${{ github.ref_name }}
          prerelease: false
          draft: false
          generate_release_notes: false
          body: ${{ steps.ai_notes.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  # Unraid Plugin Release (generiert .plg und .txz Dateien)
  unraid-plugin:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Build and Package Plugin
        id: build
        run: |
          # Make build script executable
          chmod +x build.sh
          
          # Run build script to populate src/ directory
          ./build.sh
          
          # Determine version (strip 'v' prefix if present)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          PACKAGE_NAME="mcmm-plugin"
          PACKAGE_FILE="${PACKAGE_NAME}-${VERSION}-noarch-1.txz"
          
          echo "Building package version: $VERSION"
          echo "Package file: $PACKAGE_FILE"
          
          # Create release directory
          mkdir -p release
          
          # Create txz package from src directory
          cd src
          tar --owner=0 --group=0 -cJf "../release/${PACKAGE_FILE}" *
          cd ..
          
          # Calculate checksum
          CHECKSUM=$(sha256sum "release/${PACKAGE_FILE}" | awk '{print $1}')
          
          echo "Package created at: release/${PACKAGE_FILE}"
          echo "Checksum: $CHECKSUM"
          
          # Export variables for next steps
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"
          echo "package_file=release/$PACKAGE_FILE" >> "$GITHUB_OUTPUT"

      - name: Generate PLG file
        uses: dkaser/jinja2-action@v1
        with:
          template: plugin/plugin.j2
          output_file: plugin/mcmm.plg
          data_file: plugin/plugin.json
        env:
          PLUGIN_VERSION: ${{ steps.build.outputs.version }}
          # Simple changelog link
          PLUGIN_CHANGELOG: "Release notes: ${{ github.event.release.html_url }}"
          PLUGIN_CHECKSUM: ${{ steps.build.outputs.checksum }}
          PLUGIN_RELEASE: ""
          PLUGIN_TAG: ${{ github.event.release.tag_name }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
          
      - name: Commit PLG file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plugin/mcmm.plg
          # Only commit if there are changes (ignore errors if empty commit)
          git commit -m "chore: update plugin file for release ${{ github.event.release.tag_name }}" || echo "No changes to commit"
          git push origin HEAD:main
          
      - name: Upload Package Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.build.outputs.package_file }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
