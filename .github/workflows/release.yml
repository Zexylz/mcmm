name: Create Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Release Package
        run: |
          mkdir -p release/mcmm
          cp -r include release/mcmm/
          cp -r javascript release/mcmm/
          cp -r styles release/mcmm/
          cp api.php release/mcmm/
          cp default.cfg release/mcmm/
          cp .htaccess release/mcmm/
          cp mcmm.page release/mcmm/
          cp mcmm.plg release/mcmm/
          cd release
          zip -r ../mcmm-plugin.zip mcmm

      # Nur für main-Pushes (kein Tag): Datum setzen
      - name: Set date
        if: github.ref_type != 'tag'
        run: echo "DATE=$(date -u +%Y%m%d)" >> $GITHUB_ENV

      # Nightly changelog generieren (schön & technisch, robust gegen EOF-Probleme)
      - name: Generate Nightly Changelog (pretty, squash-friendly)
        if: github.ref_type != 'tag'
        shell: bash
        run: |
          set -euo pipefail

          LAST_TAG="$(git tag --list "nightly-*" --sort=-creatordate | head -n 1 || true)"
          REPO="${GITHUB_REPOSITORY}"
          OUT="changelog.md"

          pr_linkify () {
            local s="$1"
            if [[ "$s" =~ \(\#([0-9]+)\) ]]; then
              local pr="${BASH_REMATCH[1]}"
              s="${s/(\#${pr})/ [#${pr}](https:\/\/github.com\/${REPO}\/pull\/${pr})}"
            fi
            echo "$s"
          }

          {
            echo "## Nightly Changelog"
            echo
            echo "- Commit: \`${GITHUB_SHA:0:7}\`"
            echo "- Run: #${GITHUB_RUN_NUMBER}"
            echo "- Trigger: ${GITHUB_EVENT_NAME}"
            echo
          } > "$OUT"

          if [[ -z "$LAST_TAG" ]]; then
            {
              echo "No previous nightly tag found. This is the first nightly release."
              echo
              echo "### Changes"
              git log -n 50 --no-merges --pretty=format:"- %s (\`%h\`, %an)"
            } >> "$OUT"
          else
            {
              echo "Previous nightly: \`${LAST_TAG}\`"
              echo
              echo "[Compare changes](https://github.com/${REPO}/compare/${LAST_TAG}...${GITHUB_SHA})"
              echo
            } >> "$OUT"

            COMMITS="$(git log "${LAST_TAG}..HEAD" --no-merges --pretty=format:'%s|%h|%an')"

            declare -A sections=(
              [Features]=""
              [Fixes]=""
              [Performance]=""
              [Refactor]=""
              [Docs]=""
              [Tests]=""
              [Build]=""
              [CI]=""
              [Chore]=""
              [Other]=""
            )

            while IFS= read -r row; do
              [[ -z "$row" ]] && continue
              subject="${row%%|*}"
              rest="${row#*|}"
              hash="${rest%%|*}"
              author="${rest#*|}"

              pretty="$(pr_linkify "$subject")"
              line="- ${pretty} (\`${hash}\`, ${author})"

              case "$subject" in
                feat:*|feat\(*\):*)         sections[Features]+="$line"$'\n' ;;
                fix:*|fix\(*\):*)           sections[Fixes]+="$line"$'\n' ;;
                perf:*|perf\(*\):*)         sections[Performance]+="$line"$'\n' ;;
                refactor:*|refactor\(*\):*) sections[Refactor]+="$line"$'\n' ;;
                docs:*|docs\(*\):*)         sections[Docs]+="$line"$'\n' ;;
                test:*|tests:*|test\(*\):*) sections[Tests]+="$line"$'\n' ;;
                build:*|build\(*\):*)       sections[Build]+="$line"$'\n' ;;
                ci:*|ci\(*\):*)             sections[CI]+="$line"$'\n' ;;
                chore:*|chore\(*\):*)       sections[Chore]+="$line"$'\n' ;;
                *)                          sections[Other]+="$line"$'\n' ;;
              esac
            done <<< "$COMMITS"

            for key in Features Fixes Performance Refactor Docs Tests Build CI Chore Other; do
              if [[ -n "${sections[$key]}" ]]; then
                echo "### $key" >> "$OUT"
                echo >> "$OUT"
                echo "${sections[$key]}" >> "$OUT"
              fi
            done
          fi

          {
            echo "CHANGELOG<<EOF"
            cat "$OUT"
            echo "EOF"
          } >> "$GITHUB_ENV"

      # Nightly prerelease bei JEDEM Push auf main (mit Changelog in der Beschreibung)
      - name: Create GitHub Release (nightly)
        if: github.ref_type != 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: mcmm-plugin.zip
          tag_name: nightly-${{ env.DATE }}-${{ github.run_number }}
          name: Nightly ${{ env.DATE }} (#${{ github.run_number }})
          prerelease: true
          draft: false
          generate_release_notes: false
          body: ${{ env.CHANGELOG }}
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Normale Release bei v* Tag-Push
      - name: Create GitHub Release (tag)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: mcmm-plugin.zip
          tag_name: ${{ github.ref_name }}
          prerelease: false
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}