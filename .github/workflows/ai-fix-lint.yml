name: AI Fix Lint Errors

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target to fix (css, js, html)"
        required: true
        default: "css"
        type: choice
        options:
          - css
          - js
          - html

jobs:
  fix-lint:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Setup Node
        uses: actions/setup-node@v6.2.0
        with:
          node-version: "20"
          
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          coverage: none
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' 
          
      - name: Install Dependencies
        run: |
          npm ci --no-audit --no-fund
          pip install google-generativeai
          
      # --- CSS FIXING ---
      - name: Extract CSS (Mirror of style-checks)
        if: inputs.target == 'css'
        shell: bash
        run: |
          mkdir -p .tmp-stylelint
          shopt -s globstar nullglob
          mapfile -t page_files < <(printf '%s\n' **/*.page)
          for f in "${page_files[@]}"; do
             out_style=".tmp-stylelint/${f}.style.css"
             out_inline=".tmp-stylelint/${f}.inline.css"
             mkdir -p "$(dirname "$out_style")" "$(dirname "$out_inline")"
             
             awk '
               BEGIN { in_style=0 }
               {
                 line=$0
                 low=tolower($0)
                 if (!in_style) {
                   if (low ~ /<style([[:space:]][^>]*)?>/) {
                     in_style=1
                     sub(/.*<style([[:space:]][^>]*)?>/,"",line)
                     if (length(line) > 0) print line; else print ""
                     next
                   }
                   print ""
                   next
                 } else {
                   if (low ~ /<\/style>/) {
                     sub(/<\/style>.*/,"",line)
                     if (length(line) > 0) print line; else print ""
                     in_style=0
                     next
                   }
                   print $0
                 }
               }
             ' "$f" > "$out_style"
             
             perl -ne '
               BEGIN { $ln = 0; $idx = 0; $in_script = 0; $in_style  = 0; }
               sub decode_entities { my ($s) = @_; $s =~ s/&quot;/"/g; $s =~ s/&apos;/'\''/g; $s =~ s/&lt;/</g; $s =~ s/&gt;/>/g; $s =~ s/&amp;/&/g; return $s; }
               sub normalize_decls { my ($s) = @_; $s =~ s/^\s+|\s+$//g; $s =~ s/\s*;\s*$/;/; $s .= ";" if $s !~ /;\s*$/; return $s; }
               $ln++;
               my $line = $_;
               my $low  = lc($line);
               if (!$in_script && $low =~ /<script\b/) { $in_script = 1; }
               if ($in_script) { print "\n"; if ($low =~ /<\/script>/) { $in_script = 0; } next; }
               if (!$in_style && $low =~ /<style\b/) { $in_style = 1; }
               if ($in_style) { print "\n"; if ($low =~ /<\/style>/) { $in_style = 0; } next; }
               $line =~ s/<\?(?:php|=)?.*?\?>//g;
               my @rules = ();
               while ($line =~ /style\s*=\s*"([^"]*)"/gi) {
                 my $s = decode_entities($1);
                 next if $s =~ /<\?/ || $s =~ /\?>/;
                 next if $s =~ /^\s*$/;
                 $s = normalize_decls($s);
                 $idx++;
                 push @rules, ".__inline_style_$idx__ { $s }";
               }
               while ($line =~ /style\s*=\s*'\''([^'\'']*)'\''/gi) {
                 my $s = decode_entities($1);
                 next if $s =~ /<\?/ || $s =~ /\?>/;
                 next if $s =~ /^\s*$/;
                 $s = normalize_decls($s);
                 $idx++;
                 push @rules, ".__inline_style_$idx__ { $s }";
               }
               if (@rules) { print join(" ", @rules), "\n"; } else { print "\n"; }
             ' "$f" > "$out_inline"
          done
          find .tmp-stylelint -type f -name "*.css" -exec sh -c 'grep -q "[^[:space:]]" "$1" || rm -f "$1"' _ {} \; || true

      - name: Run Stylelint & Generate Report
        if: inputs.target == 'css'
        continue-on-error: true
        run: |
          npx stylelint "**/*.css" ".tmp-stylelint/**/*.css" --config .github/linters/.stylelintrc.json --formatter json > stylelint-report.json || true
          
      - name: Parse Report & Fix with AI
        if: inputs.target == 'css'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python .github/scripts/ai_fix.py --linter stylelint --report stylelint-report.json

      # --- COMMIT ---
      - name: Commit Fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "style: auto-fix lint errors with AI (Gemini)" || echo "No changes"
          git push
